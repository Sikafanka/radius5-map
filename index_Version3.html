<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Radius 5 ‚Äî MiniApp</title>

<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.min.js"></script>

<style>
  /* Reset tap highlights */
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  :root{
    --bg:#0b0f16; --panel:#0d1422; --txt:#e9efff; --muted:#9fb0d9;
    --grad1:#7c3aed; --grad2:#22d3ee;
    --map-tiles:url('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
  }
  
  [data-theme="light"] {
    --bg:#f8fafc; --panel:#ffffff; --txt:#1e293b; --muted:#64748b;
    --grad1:#7c3aed; --grad2:#22d3ee;
    --map-tiles:url('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
  }

  html,body,#app{
    height:100%;margin:0;background:var(--bg);color:var(--txt);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    transition:all 0.3s ease;
    overflow: hidden;
  }
  
  /* Make sure map is visible and occupies full container */
  #map{
    height:100%;position:relative;
    z-index: 0; /* below UI elements */
  }
  
  #ui{position:absolute;inset:0;pointer-events:none;z-index:900}
  
  .topbar{
    position:absolute;left:12px;right:12px;top:8px;display:flex;gap:10px;align-items:center;pointer-events:auto;flex-wrap:wrap;
    background:linear-gradient(180deg,rgba(13,22,38,.80),rgba(10,18,32,.78));
    border:1px solid rgba(140,160,255,.12);
    border-radius:18px;padding:10px 12px;backdrop-filter:blur(6px);
    /* Prevent background bleed artifacts behind rounded corners on some devices */
    overflow: hidden;
    /* ensure topbar doesn't cover map tiles (map canvas below) */
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  [data-theme="light"] .topbar{
    background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(248,250,252,.93));
    border:1px solid rgba(99,102,241,.15);
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    overflow: hidden;
  }
  
  .chips{display:flex;gap:8px;overflow:auto;scrollbar-width:none;flex:1 1 auto;padding:4px 2px;}
  .chips::-webkit-scrollbar{display:none}
  .chip{
    background:#0e1624;color:var(--muted);padding:8px 12px;border-radius:12px;
    font-weight:700;white-space:nowrap;cursor:pointer;transition:all 0.2s ease;
    border: none;
    outline: none;
    position:relative;
    /* Fix: ensure gradient/rounding doesn't show stray vertical artifacts by clipping */
    overflow:hidden;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    /* Force no image repetition artifacts */
    background-repeat: no-repeat;
    background-size: 100% 100%;
    box-shadow: none;
  }
  .chip.active{background:#17243a;color:#fff}
  [data-theme="light"] .chip{background:#f1f5f9;color:#64748b;border:1px solid #e2e8f0}
  [data-theme="light"] .chip.active{
    /* Fix: use a single smooth gradient + clip and no extra borders to avoid side stripes */
    background: linear-gradient(90deg,var(--grad1),var(--grad2));
    background-size: 100% 100%;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    color:#fff;border-color:transparent;
  }
  
  .cta{
    position:absolute;left:20px;right:96px;bottom:24px;height:56px;border-radius:16px;z-index:960;
    background:linear-gradient(90deg,var(--grad1),var(--grad2));display:flex;align-items:center;justify-content:center;
    color:white;font-weight:900;letter-spacing:.4px;pointer-events:auto;cursor:pointer;transition:all 0.2s ease;
    box-shadow:0 4px 16px rgba(124,58,237,.3);
    border: none;
    outline: none;
  }
  .cta:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(124,58,237,.4)}
  
  .settings-btn{
    position:absolute;right:20px;bottom:24px;width:56px;height:56px;border-radius:16px;z-index:961; pointer-events:auto;
    background:linear-gradient(135deg, var(--grad2), var(--grad1)); display:grid;place-items:center;cursor:pointer;transition:all 0.2s ease;
    box-shadow:0 4px 16px rgba(34,211,238,.3);
    border: none;
    outline: none;
  }
  .settings-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(34,211,238,.4)}
  .settings-btn svg{ width:24px;height:24px; stroke:#fff; stroke-width:1.8; fill:none }
  
  /* –ö–Ω–æ–ø–∫–∞ Delete - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–∞ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø—É–ª—å—Å–∞ */
  .delete-btn-pulse{
    position:absolute;right:88px;bottom:24px;width:56px;height:56px;border-radius:16px;z-index:961; pointer-events:auto;
    background:linear-gradient(135deg, #ef4444, #dc2626); display:grid;place-items:center;cursor:pointer;transition:all 0.2s ease;
    box-shadow:0 4px 16px rgba(239,68,68,.3);
    border: none;
    outline: none;
  }
  .delete-btn-pulse:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(239,68,68,.4)}
  .delete-btn-pulse svg{ width:24px;height:24px; stroke:#fff; stroke-width:2; fill:none }
  
  .leaflet-control-zoom,.leaflet-control-attribution{display:none!important}

  /* –º–∞—Ä–∫–µ—Ä—ã —Å —Ü–≤–µ—Ç–∞–º–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ */
  .pulse{width:52px;height:52px;border-radius:50%;position:relative;display:grid;place-items:center}
  .pulse::after{content:"";position:absolute;inset:-2px;border-radius:50%;box-shadow:0 0 16px currentColor,inset 0 0 8px rgba(255,255,255,.2)}
  [data-theme="light"] .pulse::after{box-shadow:0 0 16px currentColor,inset 0 0 8px rgba(255,255,255,.4)}
  
  /* –¶–≤–µ—Ç–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏: –∑–µ–ª–µ–Ω—ã–π (0-30–º–∏–Ω), –æ—Ä–∞–Ω–∂–µ–≤—ã–π (30-60–º–∏–Ω), –∫—Ä–∞—Å–Ω—ã–π (60-120–º–∏–Ω) */
  .pulse-green{ --c:#10b981; color: #10b981; }
  .pulse-orange{ --c:#f97316; color: #f97316; }
  .pulse-red{ --c:#ef4444; color: #ef4444; }
  
  /* –ê–Ω–∏–º–∞—Ü–∏–∏ —Å —Ä–∞–∑–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é */
  .ring{position:absolute;inset:-10px;border-radius:50%;border:2px solid var(--c);opacity:.45}
  .ring-fast{animation:ring 2s ease-out infinite}
  .ring-medium{animation:ring 3s ease-out infinite}
  .ring-slow{animation:ring 4s ease-out infinite}
  
  .pulse>span{font-size:26px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.45))}
  @keyframes ring{0%{transform:scale(.7);opacity:.6}50%{transform:scale(1.6);opacity:.3}100%{transform:scale(1.85);opacity:0}}
  
  .leaflet-tooltip.pulse-label{
    background:rgba(10,14,22,.92);color:#e6ecff;padding:12px 16px;border-radius:16px;border:1px solid rgba(120,160,255,.26);
    min-width:200px;backdrop-filter:blur(8px);
  }
  [data-theme="light"] .leaflet-tooltip.pulse-label{
    background:rgba(255,255,255,.95);color:#1e293b;border:1px solid rgba(99,102,241,.2);
    box-shadow:0 8px 25px rgba(0,0,0,.12);
  }
  
  .meDot{width:18px;height:18px;border-radius:50%;background:#10b981;border:3px solid rgba(16,185,129,.9);
    box-shadow:0 0 12px rgba(16,185,129,.5),0 0 0 8px rgba(16,185,129,.08);animation:me 1.6s ease-out infinite}
  @keyframes me{0%{transform:scale(.94)}50%{transform:scale(1.04)}100%{transform:scale(.94)}}

  /* –º–æ–¥–∞–ª–∫–∏ */
  .modal{
    position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;
    background:rgba(0,0,0,.35);z-index:1200;
  }
  .modal.open{display:flex}
  .sheet{
    width:100%;background:#0f1729;border:1px solid rgba(140,160,255,.14);
    border-radius:16px 16px 0 0;padding:16px;max-height:90vh;overflow-y:auto;
  }
  [data-theme="light"] .sheet{
    background:#ffffff;border:1px solid rgba(99,102,241,.15);
    box-shadow:0 -4px 20px rgba(0,0,0,.1);
  }
  .row{display:flex;gap:10px;margin:12px 0}
  .input,select,textarea{
    width:100%;background:#0e1624;border:1px solid rgba(255,255,255,.08);
    color:#e9efff;border-radius:12px;padding:12px;transition:all 0.2s ease;
    border: none;
    outline: none;
  }
  [data-theme="light"] .input,[data-theme="light"] select,[data-theme="light"] textarea{
    background:#f8fafc;border:1px solid #e2e8f0;color:#1e293b;
  }
  .input:focus,select:focus,textarea:focus{
    outline:none;border-color:var(--grad1);
  }
  
  .btn{
    padding:12px;border-radius:12px;text-align:center;background:#0e1624;
    border:1px solid rgba(255,255,255,.08);cursor:pointer;transition:all 0.2s ease;
    border: none;
    outline: none;
  }
  .btn.primary{
    background:linear-gradient(90deg,var(--grad1),var(--grad2));border:0;font-weight:800;
  }
  [data-theme="light"] .btn{
    background:#f1f5f9;border:1px solid #e2e8f0;color:#475569;
  }
  .footer{display:flex;gap:10px;margin-top:16px}
  .hint{color:#9fb0d9;font-size:12px;margin-top:4px}
  [data-theme="light"] .hint{color:#64748b}
  
  /* Location selection */
  .location-options{display:flex;gap:10px;margin:12px 0}
  .location-option{
    flex:1;text-align:center;padding:12px;background:#0e1624;
    border:1px solid rgba(255,255,255,.08);border-radius:12px;cursor:pointer;
    transition:all 0.2s ease;
    border: none;
    outline: none;
    position:relative;
    overflow:hidden;
    background-repeat:no-repeat;
    background-size:100% 100%;
    -webkit-background-clip:padding-box;
    background-clip:padding-box;
  }
  .location-option.active{background:#17243a;border-color:var(--grad1)}
  [data-theme="light"] .location-option{
    background:#f8fafc;border:1px solid #e2e8f0;color:#475569;
  }
  [data-theme="light"] .location-option.active{
    background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#fff;border-color:transparent;
  }
  
  /* Map for location selection */
  #locationMap{
    height:200px;border-radius:12px;margin:12px 0;border:1px solid rgba(255,255,255,.08);
  }
  [data-theme="light"] #locationMap{border:1px solid #e2e8f0}
  
  /* Address input */
  .address-input{position:relative}
  .address-placeholder{
    position:absolute;top:12px;left:12px;color:#6b7280;
    pointer-events:none;transition:all 0.2s;
  }
  .address-input input:focus + .address-placeholder,
  .address-input input:not(:placeholder-shown) + .address-placeholder{
    display:none;
  }
  
  /* Confirm location button */
  .confirm-location-btn{
    background:linear-gradient(90deg,var(--grad1),var(--grad2));
    color:white;
    border:none;
    padding:12px;
    border-radius:12px;
    font-weight:700;
    cursor:pointer;
    width:100%;
    margin-top:12px;
    transition:all 0.2s ease;
    outline: none;
  }
  .confirm-location-btn:hover{
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(124,58,237,0.3);
  }
  
  /* –ö–Ω–æ–ø–∫–∞ Join */
  .join-btn{
    background:linear-gradient(90deg,var(--grad1),var(--grad2));
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:12px;
    font-weight:700;
    cursor:pointer;
    margin-top:12px;
    width:100%;
    transition:all 0.2s ease;
    outline: none;
  }
  .join-btn:hover{
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(124,58,237,0.3);
  }
  .join-btn:active{
    transform:translateY(0);
  }

  /* Delete pulse button in tooltip */
  .delete-btn{
    background:linear-gradient(90deg, #ef4444, #dc2626);
    color:white;
    border:none;
    padding:8px 16px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
    margin-top:8px;
    width:100%;
    transition:all 0.2s ease;
    outline: none;
    font-size:12px;
  }
  .delete-btn:hover{
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(239,68,68,0.3);
  }

  /* –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è */
  .pulse-time{
    color:#9fb0d9;
    font-size:11px;
    margin:4px 0 8px 0;
    display:flex;
    align-items:center;
    gap:4px;
  }
  [data-theme="light"] .pulse-time{color:#64748b}
  .pulse-time::before{
    content:'üïí';
    font-size:10px;
  }

  /* Settings styles */
  .settings-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 0;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  [data-theme="light"] .settings-item{
    border-bottom:1px solid #e2e8f0;
  }
  .settings-item:last-child{
    border-bottom:none;
  }
  .settings-label{
    font-weight:600;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .settings-description{
    color:#9fb0d9;
    font-size:12px;
    margin-top:4px;
  }
  [data-theme="light"] .settings-description{color:#64748b}
  
  .toggle{
    width:44px;
    height:24px;
    background:#1e293b;
    border-radius:12px;
    position:relative;
    cursor:pointer;
    transition:all 0.3s ease;
    border: none;
    outline: none;
  }
  [data-theme="light"] .toggle{background:#cbd5e1}
  .toggle.active{
    background:linear-gradient(90deg,var(--grad1),var(--grad2));
  }
  .toggle::after{
    content:'';
    position:absolute;
    width:20px;
    height:20px;
    background:white;
    border-radius:50%;
    top:2px;
    left:2px;
    transition:all 0.3s ease;
    box-shadow:0 1px 3px rgba(0,0,0,.2);
  }
  .toggle.active::after{
    left:22px;
  }
  
  .slider{
    width:100%;
    margin:16px 0;
    -webkit-appearance:none;
    background:#1e293b;
    border-radius:8px;
    height:6px;
    outline: none;
  }
  [data-theme="light"] .slider{background:#cbd5e1}
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:20px;
    height:20px;
    border-radius:50%;
    background:linear-gradient(90deg,var(--grad1),var(--grad2));
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
    border: none;
    outline: none;
  }
  .slider-value{
    text-align:center;
    color:var(--txt);
    font-weight:700;
    margin-top:8px;
  }

  /* Location selection overlay - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ */
  .location-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    z-index:1300;
    display:none;
    flex-direction:column;
  }
  .location-overlay.active{
    display:flex;
  }
  .location-header{
    background:var(--panel);
    padding:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid rgba(255,255,255,.1);
  }
  [data-theme="light"] .location-header{
    border-bottom:1px solid #e2e8f0;
  }
  .location-map{
    flex:1;
    position:relative;
  }
  .location-marker{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:1000;
    font-size:32px;
    filter:drop-shadow(0 2px 8px rgba(0,0,0,.5));
  }
  /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è - –±–µ–∑ –ª–∏—à–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  .location-instruction{
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    text-align:center;
    color:white;
    font-weight:600;
    z-index:1000;
    background:rgba(0,0,0,.7);
    padding:8px 16px;
    border-radius:12px;
    backdrop-filter:blur(8px);
    white-space: nowrap;
  }
  [data-theme="light"] .location-instruction{
    color:#1e293b;
    background:rgba(255,255,255,.9);
  }

  /* Help icon */
  .help-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--muted);
    color: var(--bg);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    cursor: help;
  }

  /* Visibility options */
  .visibility-options {
    margin-top: 12px;
    padding: 12px;
    background: rgba(255,255,255,.05);
    border-radius: 12px;
    display: none;
  }
  [data-theme="light"] .visibility-options {
    background: rgba(0,0,0,.03);
  }
  .visibility-options.active {
    display: block;
  }
  .visibility-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,.1);
  }
  [data-theme="light"] .visibility-option {
    border-bottom: 1px solid rgba(0,0,0,.1);
  }
  .visibility-option:last-child {
    border-bottom: none;
  }
  .visibility-label {
    font-weight: 500;
    font-size: 14px;
  }
  .visibility-description {
    color: var(--muted);
    font-size: 11px;
    margin-top: 2px;
  }

  /* Language selector */
  .language-selector {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .language-option {
    flex: 1;
    padding: 8px 12px;
    background: #0e1624;
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    background-repeat: no-repeat;
    background-size: 100% 100%;
  }
  [data-theme="light"] .language-option {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    color: #475569;
  }
  .language-option.active {
    /* Fix: consistent gradient + clip to avoid side artifacts */
    background: linear-gradient(90deg, var(--grad1), var(--grad2));
    background-size: 100% 100%;
    color: white;
    border-color: transparent;
  }

  /* Ensure rounded elements render cleanly on some Android WebViews */
  .chip, .language-option, .location-option {
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <div id="ui">
    <div class="topbar">
      <div class="chips" id="chips"></div>
    </div>
  </div>

  <div class="cta" id="createBtn">+ –°–û–ó–î–ê–¢–¨ –ü–£–õ–¨–°</div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ Delete - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–∞ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø—É–ª—å—Å–∞ -->
  <button class="delete-btn-pulse" id="deletePulseBtn" title="–£–¥–∞–ª–∏—Ç—å –ø—É–ª—å—Å" style="display: none;">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 6h18"></path>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
      <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      <line x1="10" y1="11" x2="10" y2="17"></line>
      <line x1="14" y1="11" x2="14" y2="17"></line>
    </svg>
  </button>
  
  <div class="settings-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
      <g transform="translate(12 12)">
        <circle r="7.2"></circle><rect x="-1" y="-11.2" width="2" height="3.4" rx="1"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(45)"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(90)"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(135)"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(180)"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(225)"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(270)"/>
        <rect x="-1" y="-11.2" width="2" height="3.4" rx="1" transform="rotate(315)"/>
        <circle r="3.4"></circle>
      </g>
    </svg>
  </div>

  <!-- Location Selection Overlay - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô -->
  <div class="location-overlay" id="locationOverlay">
    <div class="location-header">
      <h3 style="margin:0">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é</h3>
      <div class="btn" id="cancelLocationSelect">–û—Ç–º–µ–Ω–∞</div>
    </div>
    <div class="location-map" id="locationSelectMap">
      <div class="location-instruction">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏</div>
    </div>
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω–∞ –ª–∏—à–Ω—è—è –æ–±–µ—Ä—Ç–∫–∞ —Å –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º -->
    <div style="padding:16px;background:transparent">
      <button class="confirm-location-btn" id="confirmLocationSelect">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</button>
    </div>
  </div>

  <!-- Modal create pulse -->
  <div class="modal" id="createModal">
    <div class="sheet">
      <h3>–°–æ–∑–¥–∞—Ç—å –ø—É–ª—å—Å</h3>
      
      <div class="row">
        <select id="cat">
          <option value="sport">üèÉ –°–ø–æ—Ä—Ç</option>
          <option value="games">üéÆ –ò–≥—Ä—ã</option>
          <option value="art">üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ</option>
          <option value="social">üë• –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ</option>
          <option value="creative">üí° –ö—Ä–µ–∞—Ç–∏–≤</option>
          <option value="chill">üòå –û—Ç–¥—ã—Ö</option>
          <option value="active">‚ö° –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</option>
          <option value="dating">üíï –ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
          <option value="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
          <option value="animal">üêï –ñ–∏–≤–æ—Ç–Ω—ã–µ</option>
          <option value="help">ü§ù –ü–æ–º–æ—â—å</option>
        </select>
      </div>
      
      <!-- –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª—é–¥–µ–π –æ—Ç 1 –¥–æ 5 -->
      <div class="row">
        <select id="peopleCount">
          <option value="1">1 —á–µ–ª–æ–≤–µ–∫</option>
          <option value="2">2 —á–µ–ª–æ–≤–µ–∫–∞</option>
          <option value="3">3 —á–µ–ª–æ–≤–µ–∫–∞</option>
          <option value="4">4 —á–µ–ª–æ–≤–µ–∫–∞</option>
          <option value="5" selected>5 —á–µ–ª–æ–≤–µ–∫</option>
        </select>
      </div>
      
      <div class="row">
        <textarea id="msg" rows="3" class="input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      </div>
      
      <div class="row">
        <div style="width:100%">
          <div style="margin-bottom:8px; font-weight:600">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é</div>
          <div class="location-options">
            <div class="location-option" id="customLocation">üó∫Ô∏è –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</div>
            <div class="location-option active" id="addressLocation">üìç –£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å</div>
          </div>
        </div>
      </div>
      
      <div id="addressInputContainer">
        <div class="address-input">
          <input type="text" id="addressInput" class="input" placeholder="" style="padding-left:12px">
          <div class="address-placeholder">–≤–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å</div>
        </div>
      </div>
      
      <div id="locationMapContainer" style="display:none">
        <div class="hint">–í—ã–±—Ä–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
      </div>
      
      <div class="footer">
        <div class="btn" id="cancelCreate">–û—Ç–º–µ–Ω–∞</div>
        <div class="btn primary" id="saveCreate">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</div>
      </div>
    </div>
  </div>

  <!-- Modal Settings -->
  <div class="modal" id="settingsModal">
    <div class="sheet">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
          <div class="settings-description">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏</div>
        </div>
        <div class="toggle active" id="darkModeToggle"></div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ—é –ª–æ–∫–∞—Ü–∏—é</div>
          <div class="settings-description">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤–∞—à—É –ª–æ–∫–∞—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ</div>
        </div>
        <div class="toggle active" id="showLocationToggle"></div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—É–ª—å—Å–∞—Ö</div>
          <div class="settings-description">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø—É–ª—å—Å–∞—Ö —Ä—è–¥–æ–º</div>
        </div>
        <div class="toggle active" id="notificationsToggle"></div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞</div>
          <div class="settings-description">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–∫ –¥–∞–ª–µ–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—É–ª—å—Å—ã</div>
        </div>
        <div style="width:120px">
          <input type="range" min="1" max="10" value="5" class="slider" id="radiusSlider">
          <div class="slider-value" id="radiusValue">2.5 –∫–º</div>
        </div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–í–∏–¥–∏–º–æ—Å—Ç—å –ø—É–ª—å—Å–æ–≤</div>
          <div class="settings-description">–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –∫—Ç–æ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à–∏ –ø—É–ª—å—Å—ã</div>
        </div>
        <div class="toggle" id="pulseVisibilityToggle"></div>
      </div>
      
      <div class="visibility-options" id="visibilityOptions">
        <div class="visibility-option">
          <div>
            <div class="visibility-label">–ü—É–±–ª–∏—á–Ω—ã–π</div>
            <div class="visibility-description">–í–∏–¥—è—Ç –≤—Å–µ –≤ —Ä–∞–¥–∏—É—Å–µ</div>
          </div>
          <div class="toggle active" data-visibility="public"></div>
        </div>
        <div class="visibility-option">
          <div>
            <div class="visibility-label">–õ–æ–∫–∞–ª—å–Ω—ã–π</div>
            <div class="visibility-description">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä—è–¥–æ–º –∑–∞ 24—á</div>
          </div>
          <div class="toggle" data-visibility="local"></div>
        </div>
        <div class="visibility-option">
          <div>
            <div class="visibility-label">–ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
            <div class="visibility-description">–¢–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</div>
          </div>
          <div class="toggle" data-visibility="private"></div>
        </div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
          <div class="settings-description">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
        </div>
      </div>
      
      <div class="language-selector">
        <div class="language-option active" data-lang="ru">–†—É—Å—Å–∫–∏–π</div>
        <div class="language-option" data-lang="en">English</div>
        <div class="language-option" data-lang="kz">“ö–∞–∑–∞“õ—à–∞</div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã</div>
          <div class="settings-description">–û–±–Ω–æ–≤–ª—è—Ç—å –ø—É–ª—å—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
        </div>
        <div class="toggle" id="autoRefreshToggle"></div>
      </div>
      
      <div class="settings-item">
        <div>
          <div class="settings-label">–í–∏–±—Ä–∞—Ü–∏—è</div>
          <div class="settings-description">–¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
        </div>
        <div class="toggle active" id="vibrationToggle"></div>
      </div>
      
      <div class="footer">
        <div class="btn" id="cancelSettings">–ó–∞–∫—Ä—ã—Ç—å</div>
        <div class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------- CONFIG -------------------- */
/* NOTE: Supabase keys are present in the prototype. For production move them to secure env or server. */
const SUPABASE_URL = "https://gubjmpukjzdlmnzdyluy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1YmptcHVranpkbG1uemR5bHV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNTQzMTIsImV4cCI6MjA3NzczMDMxMn0.jWVJGaTi7t24KLn3agw5HBSzFfjb0lU6GnFXREH9PfA";

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à —Å—Ö–µ–º—ã
setTimeout(async () => {
  try {
    const { data, error } = await db.from('pulses').select('people_count').limit(1);
    console.log('Schema cache refreshed');
  } catch (e) {
    console.log('Cache refresh attempt');
  }
}, 1000);

/* -------------------- LANGUAGE MANAGEMENT -------------------- */
const translations = {
  ru: {
    createPulse: "–°–û–ó–î–ê–¢–¨ –ü–£–õ–¨–°",
    createPulseTitle: "–°–æ–∑–¥–∞—Ç—å –ø—É–ª—å—Å",
    sport: "–°–ø–æ—Ä—Ç",
    games: "–ò–≥—Ä—ã", 
    art: "–ò—Å–∫—É—Å—Å—Ç–≤–æ",
    social: "–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ",
    creative: "–ö—Ä–µ–∞—Ç–∏–≤",
    chill: "–û—Ç–¥—ã—Ö",
    active: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
    dating: "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞",
    education: "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
    animal: "–ñ–∏–≤–æ—Ç–Ω—ã–µ",
    help: "–ü–æ–º–æ—â—å",
    selectLocation: "–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é",
    chooseOnMap: "–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ",
    writeAddress: "–£–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å",
    enterAddress: "–≤–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å",
    cancel: "–û—Ç–º–µ–Ω–∞",
    publish: "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å",
    settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
    darkMode: "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞",
    showLocation: "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ—é –ª–æ–∫–∞—Ü–∏—é",
    notifications: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—É–ª—å—Å–∞—Ö",
    searchRadius: "–†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞",
    autoRefresh: "–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã",
    vibration: "–í–∏–±—Ä–∞—Ü–∏—è",
    close: "–ó–∞–∫—Ä—ã—Ç—å",
    save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
    join: "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è",
    delete: "–£–¥–∞–ª–∏—Ç—å",
    selectLocationTitle: "–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é",
    tapToSelect: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏",
    confirmLocation: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é",
    yourPulse: "–í–∞—à –ø—É–ª—å—Å",
    deleteConfirm: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—É–ª—å—Å?",
    pulseVisibility: "–í–∏–¥–∏–º–æ—Å—Ç—å –ø—É–ª—å—Å–æ–≤",
    language: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
    deletePulse: "–£–¥–∞–ª–∏—Ç—å –ø—É–ª—å—Å",
    all: "–í—Å–µ",
    peopleCount: "—á–µ–ª–æ–≤–µ–∫",
    peopleCount2: "—á–µ–ª–æ–≤–µ–∫–∞",
    locationHint: "–í—ã–±—Ä–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ",
    writeMessage: "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",
    justNow: "—Ç–æ–ª—å–∫–æ —á—Ç–æ",
    minutesAgo: "–º –Ω–∞–∑–∞–¥",
    hoursAgo: "—á –Ω–∞–∑–∞–¥",
    daysAgo: "–¥ –Ω–∞–∑–∞–¥"
  },
  en: {
    createPulse: "CREATE PULSE",
    createPulseTitle: "Create Pulse",
    sport: "Sport",
    games: "Games",
    art: "Art",
    social: "Social", 
    creative: "Creative",
    chill: "Chill",
    active: "Active",
    dating: "Dating",
    education: "Education",
    animal: "Animal",
    help: "Help",
    selectLocation: "Select location",
    chooseOnMap: "Choose on Map",
    writeAddress: "Write Address",
    enterAddress: "write correct address",
    cancel: "Cancel",
    publish: "Publish",
    settings: "Settings",
    darkMode: "Dark Mode",
    showLocation: "Show My Location",
    notifications: "Pulse Notifications",
    searchRadius: "Search Radius",
    autoRefresh: "Auto-refresh Map",
    vibration: "Vibration",
    close: "Close",
    save: "Save",
    join: "Join",
    delete: "Delete",
    selectLocationTitle: "Select Location",
    tapToSelect: "Tap on the map to select location",
    confirmLocation: "Confirm This Location",
    yourPulse: "Your pulse",
    deleteConfirm: "Delete this pulse?",
    pulseVisibility: "Pulse Visibility",
    language: "Interface Language",
    deletePulse: "Delete Pulse",
    all: "All",
    peopleCount: "person",
    peopleCount2: "people",
    locationHint: "Selected location will be shown here after choosing on the map",
    writeMessage: "Write your message...",
    justNow: "just now",
    minutesAgo: "m ago",
    hoursAgo: "h ago",
    daysAgo: "d ago"
  },
  kz: {
    createPulse: "–ü–£–õ–¨–°–¢–´ –ñ–ê–†–ò–Ø–õ–ê–£",
    createPulseTitle: "–ü—É–ª—å—Å –∂–∞—Å–∞—É",
    sport: "–°–ø–æ—Ä—Ç",
    games: "–û–π—ã–Ω–¥–∞—Ä",
    art: "”®–Ω–µ—Ä",
    social: "”ò–ª–µ—É–º–µ—Ç—Ç—ñ–∫",
    creative: "–®—ã“ì–∞—Ä–º–∞—à—ã–ª—ã“õ",
    chill: "–î–µ–º–∞–ª—É",
    active: "–ë–µ–ª—Å–µ–Ω–¥—ñ–ª—ñ–∫",
    dating: "–¢–∞–Ω—ã—Å—É",
    education: "–ë—ñ–ª—ñ–º",
    animal: "–ñ–∞–Ω—É–∞—Ä–ª–∞—Ä",
    help: "–ö”©–º–µ–∫",
    selectLocation: "–û—Ä–Ω–∞–ª–∞—Å—É–¥—ã —Ç–∞“£–¥–∞“£—ã–∑",
    chooseOnMap: "–ö–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞“£–¥–∞—É",
    writeAddress: "–ú–µ–∫–µ–Ω–∂–∞–π–¥—ã –∫”©—Ä—Å–µ—Ç—É",
    enterAddress: "–¥”ô–ª –º–µ–∫–µ–Ω–∂–∞–π–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑",
    cancel: "–ë–æ–ª–¥—ã—Ä–º–∞—É",
    publish: "–ñ–∞—Ä–∏—è–ª–∞—É",
    settings: "–ü–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä",
    darkMode: "“ö–∞—Ä–∞“£“ì—ã —Ä–µ–∂–∏–º",
    showLocation: "–ú–µ–Ω—ñ“£ –æ—Ä–Ω–∞–ª–∞—Å—É—ã–º–¥—ã –∫”©—Ä—Å–µ—Ç—É",
    notifications: "–ü—É–ª—å—Å —Ç—É—Ä–∞–ª—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä",
    searchRadius: "–Ü–∑–¥–µ—É —Ä–∞–¥–∏—É—Å—ã",
    autoRefresh: "–ö–∞—Ä—Ç–∞–Ω—ã –∞–≤—Ç–æ-–∂–∞“£–∞—Ä—Ç—É",
    vibration: "–î—ñ—Ä—ñ–ª",
    close: "–ñ–∞–±—É",
    save: "–°–∞“õ—Ç–∞—É",
    join: "“ö–æ—Å—ã–ª—É",
    delete: "–ñ–æ—é",
    selectLocationTitle: "–û—Ä–Ω–∞–ª–∞—Å—É–¥—ã —Ç–∞“£–¥–∞“£—ã–∑",
    tapToSelect: "–û—Ä–Ω–∞–ª–∞—Å—É–¥—ã —Ç–∞“£–¥–∞—É “Ø—à—ñ–Ω –∫–∞—Ä—Ç–∞–Ω—ã –±–∞—Å—ã“£—ã–∑",
    confirmLocation: "–û—Ä–Ω–∞–ª–∞—Å—É–¥—ã —Ä–∞—Å—Ç–∞—É",
    yourPulse: "–°—ñ–∑–¥—ñ“£ –ø—É–ª—å—Å—ñ“£—ñ–∑",
    deleteConfirm: "–ë“±–ª –ø—É–ª—å—Å—Ç—ñ –∂–æ—é –∫–µ—Ä–µ–∫ –ø–µ?",
    pulseVisibility: "–ü—É–ª—å—Å—Ç–µ—Ä–¥—ñ“£ –∫”©—Ä—ñ–Ω—É—ñ",
    language: "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç—ñ–ª—ñ",
    deletePulse: "–ü—É–ª—å—Å—Ç—ñ –∂–æ—é",
    all: "–ë–∞—Ä–ª—ã“ì—ã",
    peopleCount: "–∞–¥–∞–º",
    peopleCount2: "–∞–¥–∞–º",
    locationHint: "–¢–∞“£–¥–∞–ª“ì–∞–Ω –æ—Ä–Ω–∞–ª–∞—Å—É –∫–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞“£–¥–∞“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω –æ—Å—ã –∂–µ—Ä–¥–µ –∫”©—Ä—Å–µ—Ç—ñ–ª–µ–¥—ñ",
    writeMessage: "–•–∞–±–∞—Ä–ª–∞–º–∞“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑...",
    justNow: "–¥”ô–ª “õ–∞–∑—ñ—Ä",
    minutesAgo: "–º –±“±—Ä—ã–Ω",
    hoursAgo: "—Å–∞“ì –±“±—Ä—ã–Ω",
    daysAgo: "–∫“Ø–Ω –±“±—Ä—ã–Ω"
  }
};

// –ö–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤
const categoryHints = {
  ru: {
    'sport': 'üèÉ –ë–∞—Å–∫–µ—Ç–±–æ–ª –≤ –ø–∞—Ä–∫–µ, –∫—Ç–æ —Å–æ –º–Ω–æ–π?',
    'games': 'üéÆ –¢—É—Ä–Ω–∏—Ä –ø–æ Mario Kart —É –º–µ–Ω—è –¥–æ–º–∞!',
    'art': 'üé® –°–µ—Å—Å–∏—è —Å–∫–µ—Ç—á–∏–Ω–≥–∞ –≤ –ø–∞—Ä–∫–µ',
    'social': 'üë• –ö–æ—Ñ–µ –∏ –æ–±—â–µ–Ω–∏–µ –≤ Starbucks',
    'creative': 'üí° –ë—Ä–µ–π–Ω—à—Ç–æ—Ä–º–∏–Ω–≥ –Ω–æ–≤—ã—Ö –∏–¥–µ–π –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞',
    'chill': 'üòå –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∑–∞–∫–∞—Ç–æ–º –Ω–∞ –ø–ª—è–∂–µ',
    'active': '‚ö° –£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–±–µ–∂–∫–∞ –≤–æ–∫—Ä—É–≥ –æ–∑–µ—Ä–∞',
    'dating': 'üíï –ù–∞–ø–∏—Ç–∫–∏ –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä?',
    'education': 'üìö –ì—Ä—É–ø–ø–∞ –ø–æ –∏–∑—É—á–µ–Ω–∏—é –∫ —ç–∫–∑–∞–º–µ–Ω—É –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ',
    'animal': 'üêï –°–≤–∏–¥–∞–Ω–∏–µ —Å —Å–æ–±–∞–∫–∞–º–∏ –≤ —Å–æ–±–∞—á—å–µ–º –ø–∞—Ä–∫–µ',
    'help': 'ü§ù –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º –º–µ–±–µ–ª–∏'
  },
  en: {
    'sport': 'üèÉ Basketball in the park, who is with me?',
    'games': 'üéÆ Mario Kart tournament at my place!',
    'art': 'üé® Sketching session in the park',
    'social': 'üë• Coffee and chat at Starbucks',
    'creative': 'üí° Brainstorming new ideas for the project',
    'chill': 'üòå Watching the sunset on the beach',
    'active': '‚ö° Morning run around the lake',
    'dating': 'üíï Drinks and conversation?',
    'education': 'üìö Study group for math exam',
    'animal': 'üêï Doggy date at the dog park',
    'help': 'ü§ù Need help moving furniture'
  },
  kz: {
    'sport': 'üèÉ –ü–∞—Ä–∫—Ç–µ –±–∞—Å–∫–µ—Ç–±–æ–ª, –∫—ñ–º –º–µ–Ω—ñ–º–µ–Ω –±—ñ—Ä–≥–µ?',
    'games': 'üéÆ –ú–µ–Ω—ñ“£ “Ø–π—ñ–º–¥–µ Mario Kart —Ç—É—Ä–Ω–∏—Ä—ñ!',
    'art': 'üé® –ü–∞—Ä–∫—Ç–µ —ç—Å–∫–∏–∑ —Å–∞–ª—É —Å–µ—Å—Å–∏—è—Å—ã',
    'social': 'üë• Starbucks-—Ç–∞ –∫–æ—Ñ–µ –∂”ô–Ω–µ ”ô“£–≥—ñ–º–µ',
    'creative': 'üí° –ñ–æ–±–∞ “Ø—à—ñ–Ω –∂–∞“£–∞ –∏–¥–µ—è–ª–∞—Ä–¥—ã –±—Ä–µ–π–Ω—à—Ç–æ—Ä–º–∏–Ω–≥',
    'chill': 'üòå –ü–ª—è–∂–¥–∞ –∫“Ø–Ω –±–∞—Ç—É–¥—ã –±–∞“õ—ã–ª–∞—É',
    'active': '‚ö° –¢–∞“£–µ—Ä—Ç–µ“£ –∫”©–ª –∞–π–Ω–∞–ª–∞—Å—ã–Ω–¥–∞ –∂“Ø–≥—ñ—Ä—É',
    'dating': 'üíï –°—É—Å—ã–Ω–¥–∞—Ä –∂”ô–Ω–µ ”ô“£–≥—ñ–º–µ?',
    'education': 'üìö –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –µ–º—Ç–∏—Ö–∞–Ω—ã–Ω–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω –æ“õ—É —Ç–æ–±—ã',
    'animal': 'üêï –ò—Ç –ø–∞—Ä–∫—ñ–Ω–¥–µ –∏—Ç—Ç–µ—Ä–º–µ–Ω –∫–µ–∑–¥–µ—Å—É',
    'help': 'ü§ù –ñ–∏“ª–∞–∑–¥—ã –∂—ã–ª–∂—ã—Ç—É“ì–∞ –∫”©–º–µ–∫ –∫–µ—Ä–µ–∫'
  }
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤
const settingsDescriptions = {
  ru: {
    darkMode: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏',
    showLocation: '–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤–∞—à—É –ª–æ–∫–∞—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ',
    notifications: '–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø—É–ª—å—Å–∞—Ö —Ä—è–¥–æ–º',
    searchRadius: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–∫ –¥–∞–ª–µ–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—É–ª—å—Å—ã',
    autoRefresh: '–û–±–Ω–æ–≤–ª—è—Ç—å –ø—É–ª—å—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏',
    vibration: '–¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å',
    pulseVisibility: '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –∫—Ç–æ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à–∏ –ø—É–ª—å—Å—ã',
    language: '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è'
  },
  en: {
    darkMode: 'Use dark theme to save battery',
    showLocation: 'Show your location on the map',
    notifications: 'Receive notifications about new pulses nearby',
    searchRadius: 'Set how far to show pulses',
    autoRefresh: 'Automatically refresh pulses',
    vibration: 'Tactile feedback',
    pulseVisibility: 'Control who can see your pulses',
    language: 'Choose app language'
  },
  kz: {
    darkMode: '–ë–∞—Ç–∞—Ä–µ—è–Ω—ã “Ø–Ω–µ–º–¥–µ—É “Ø—à—ñ–Ω “õ–∞—Ä–∞“£“ì—ã —Ä–µ–∂–∏–º–¥—ñ –ø–∞–π–¥–∞–ª–∞–Ω—É',
    showLocation: '–ö–∞—Ä—Ç–∞–¥–∞ —Å—ñ–∑–¥—ñ“£ –æ—Ä–Ω–∞–ª–∞—Å—É—ã“£—ã–∑–¥—ã –∫”©—Ä—Å–µ—Ç—É',
    notifications: '–ñ–∞“õ—ã–Ω –∂–µ—Ä–¥–µ–≥—ñ –∂–∞“£–∞ –ø—É–ª—å—Å—Ç–µ—Ä —Ç—É—Ä–∞–ª—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä –∞–ª—É',
    searchRadius: '–ü—É–ª—å—Å—Ç–µ—Ä–¥—ñ “õ–∞–Ω—à–∞–ª—ã“õ—Ç—ã –∞–ª—ã—Å“õ–∞ –¥–µ–π—ñ–Ω –∫”©—Ä—Å–µ—Ç—É—ñ–Ω –æ—Ä–Ω–∞—Ç—ã“£—ã–∑',
    autoRefresh: '–ü—É–ª—å—Å—Ç–µ—Ä–¥—ñ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂–∞“£–∞—Ä—Ç—É',
    vibration: '–¢–∞–∫—Ç–∏–ª—å–¥—ñ –∫–µ—Ä—ñ –±–∞–π–ª–∞–Ω—ã—Å',
    pulseVisibility: '–°—ñ–∑–¥—ñ“£ –ø—É–ª—å—Å—Ç–µ—Ä—ñ“£—ñ–∑–¥—ñ –∫—ñ–º –∫”©—Ä–µ –∞–ª–∞—Ç—ã–Ω—ã–Ω –±–∞—Å“õ–∞—Ä—É',
    language: '“ö–æ–ª–¥–∞–Ω–±–∞ —Ç—ñ–ª—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑'
  }
};

let currentLanguage = 'ru';

function applyLanguage(lang) {
  currentLanguage = lang;
  const t = translations[lang];
  const desc = settingsDescriptions[lang];
  const hints = categoryHints[lang];
  
  // Update UI elements
  document.getElementById('createBtn').textContent = t.createPulse;
  document.querySelector('#createModal h3').textContent = t.createPulseTitle;
  document.querySelector('#settingsModal h3').textContent = t.settings;
  document.querySelector('#locationOverlay h3').textContent = t.selectLocationTitle;
  document.querySelector('.location-instruction').textContent = t.tapToSelect;
  document.getElementById('confirmLocationSelect').textContent = '‚úÖ ' + t.confirmLocation;
  document.getElementById('deletePulseBtn').title = t.deletePulse;
  
  // Update buttons
  document.getElementById('cancelCreate').textContent = t.cancel;
  document.getElementById('saveCreate').textContent = t.publish;
  document.getElementById('cancelLocationSelect').textContent = t.cancel;
  document.getElementById('cancelSettings').textContent = t.close;
  document.getElementById('saveSettings').textContent = t.save;
  
  // Update category options
  const catSelect = document.getElementById('cat');
  catSelect.innerHTML = `
    <option value="sport">üèÉ ${t.sport}</option>
    <option value="games">üéÆ ${t.games}</option>
    <option value="art">üé® ${t.art}</option>
    <option value="social">üë• ${t.social}</option>
    <option value="creative">üí° ${t.creative}</option>
    <option value="chill">üòå ${t.chill}</option>
    <option value="active">‚ö° ${t.active}</option>
    <option value="dating">üíï ${t.dating}</option>
    <option value="education">üìö ${t.education}</option>
    <option value="animal">üêï ${t.animal}</option>
    <option value="help">ü§ù ${t.help}</option>
  `;
  
  // Update people count options
  const peopleSelect = document.getElementById('peopleCount');
  peopleSelect.innerHTML = `
    <option value="1">1 ${t.peopleCount}</option>
    <option value="2">2 ${t.peopleCount2}</option>
    <option value="3">3 ${t.peopleCount2}</option>
    <option value="4">4 ${t.peopleCount2}</option>
    <option value="5" selected>5 ${t.peopleCount2}</option>
  `;
  
  // Update location options
  document.getElementById('customLocation').textContent = 'üó∫Ô∏è ' + t.chooseOnMap;
  document.getElementById('addressLocation').textContent = 'üìç ' + t.writeAddress;
  document.querySelector('.address-placeholder').textContent = t.enterAddress;
  const hintEl = document.querySelector('#locationMapContainer .hint');
  if (hintEl) hintEl.textContent = t.locationHint;
  
  // Update textarea placeholder with category-specific hint
  const currentCategory = document.getElementById('cat').value;
  document.getElementById('msg').placeholder = hints[currentCategory] || t.writeMessage;
  
  // Update settings labels and descriptions
  document.querySelector('#darkModeToggle').parentElement.querySelector('.settings-label').textContent = t.darkMode;
  document.querySelector('#darkModeToggle').parentElement.querySelector('.settings-description').textContent = desc.darkMode;
  
  document.querySelector('#showLocationToggle').parentElement.querySelector('.settings-label').textContent = t.showLocation;
  document.querySelector('#showLocationToggle').parentElement.querySelector('.settings-description').textContent = desc.showLocation;
  
  document.querySelector('#notificationsToggle').parentElement.querySelector('.settings-label').textContent = t.notifications;
  document.querySelector('#notificationsToggle').parentElement.querySelector('.settings-description').textContent = desc.notifications;
  
  document.querySelector('#radiusSlider').parentElement.parentElement.querySelector('.settings-label').textContent = t.searchRadius;
  document.querySelector('#radiusSlider').parentElement.parentElement.querySelector('.settings-description').textContent = desc.searchRadius;
  
  document.querySelector('#autoRefreshToggle').parentElement.querySelector('.settings-label').textContent = t.autoRefresh;
  document.querySelector('#autoRefreshToggle').parentElement.querySelector('.settings-description').textContent = desc.autoRefresh;
  
  document.querySelector('#vibrationToggle').parentElement.querySelector('.settings-label').textContent = t.vibration;
  document.querySelector('#vibrationToggle').parentElement.querySelector('.settings-description').textContent = desc.vibration;
  
  document.querySelector('#pulseVisibilityToggle').parentElement.querySelector('.settings-label').textContent = t.pulseVisibility;
  document.querySelector('#pulseVisibilityToggle').parentElement.querySelector('.settings-description').textContent = desc.pulseVisibility;
  
  document.querySelectorAll('.settings-item')[5].querySelector('.settings-label').textContent = t.language;
  document.querySelectorAll('.settings-item')[5].querySelector('.settings-description').textContent = desc.language;
  
  // Update visibility options
  document.querySelectorAll('.visibility-label').forEach((label, index) => {
    if (index === 0) label.textContent = t.public || '–ü—É–±–ª–∏—á–Ω—ã–π';
    if (index === 1) label.textContent = t.local || '–õ–æ–∫–∞–ª—å–Ω—ã–π';
    if (index === 2) label.textContent = t.private || '–ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞';
  });
  
  // Update chips
  const chips = document.querySelectorAll('.chip');
  if (chips.length > 0) {
    chips[0].textContent = t.all;
    chips[1].textContent = t.sport;
    chips[2].textContent = t.games;
    chips[3].textContent = t.art;
    chips[4].textContent = t.social;
    chips[5].textContent = t.creative;
    chips[6].textContent = t.chill;
    chips[7].textContent = t.active;
    chips[8].textContent = t.dating;
    chips[9].textContent = t.education;
    chips[10].textContent = t.animal;
    chips[11].textContent = t.help;
  }
  
  // Update language selector active state
  document.querySelectorAll('.language-option').forEach(opt => {
    opt.classList.toggle('active', opt.dataset.lang === lang);
  });
  
  // Save language preference
  localStorage.setItem('radius5_language', lang);
  
  // Re-render pulses to update time labels
  renderPulses();
}

/* -------------------- MAP OPTIMIZATION -------------------- */
const FALLBACK = [43.238949, 76.889709]; // –ê–ª–º–∞—Ç—ã

// Create optimized map with better tile loading
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  preferCanvas: true,
  zoomSnap: 0.5,
  zoomDelta: 0.5,
  wheelPxPerZoomLevel: 60,
  fadeAnimation: true,
  markerZoomAnimation: true,
  transform3DLimit: 8388608,
  maxZoom: 19,
  minZoom: 3,
  maxBounds: [[-90, -180], [90, 180]], // Prevent panning outside world
  maxBoundsViscosity: 1.0
}).setView(FALLBACK, 13);

// Dark mode tile layer
const darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  detectRetina: false,
  updateWhenIdle: true,
  reuseTiles: true,
  updateInterval: 150,
  errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
});

// Light mode tile layer
const lightTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  detectRetina: false,
  updateWhenIdle: true,
  reuseTiles: true,
  updateInterval: 150,
  errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
});

// Ensure at least one tile layer is added on init (dark by default)
darkTileLayer.addTo(map);

let radiusMeters = 2500;
let center = FALLBACK;
let locationFixed = false;

const mask = L.circle(center, {
  radius: radiusMeters,
  color: 'rgba(0,0,0,0)',
  weight: 0,
  fillColor: 'rgba(120,160,255,0.10)',
  fillOpacity: 0.34
}).addTo(map);

const ring = L.circle(center, {
  radius: radiusMeters,
  color: 'rgba(120,160,255,0.75)',
  weight: 2,
  fillOpacity: 0
}).addTo(map);

const pulsesLayer = L.layerGroup().addTo(map);

const meIcon = L.divIcon({
  className: '',
  html: '<div class="meDot"></div>',
  iconSize: [18, 18],
  iconAnchor: [9, 9]
});
let meMarker = L.marker(center, { icon: meIcon, zIndexOffset: 1000 }).addTo(map);

/* Make sure map canvas sizes correctly after initial render */
map.whenReady(() => {
  // small delay helps Leaflet compute container size correctly in some WebViews
  setTimeout(() => map.invalidateSize(), 100);
});

/* -------------------- LOCATION SELECTION MAP -------------------- */
let locationSelectMap;
let selectedLocationMarker;
let selectedLocation = null;

function initLocationSelectionMap() {
  if (locationSelectMap) {
    locationSelectMap.remove();
  }

  locationSelectMap = L.map('locationSelectMap', {
    zoomControl: false,
    attributionControl: false,
    preferCanvas: true,
    maxBounds: [[-90, -180], [90, 180]],
    maxBoundsViscosity: 1.0
  }).setView(center, 15);

  const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
  
  // Use proper dark/light tiles for location selection map
  (isDark ? darkTileLayer : lightTileLayer).addTo(locationSelectMap);

  selectedLocationMarker = L.marker(center, {
    draggable: true,
    icon: L.divIcon({
      className: 'location-marker',
      html: 'üìç',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    })
  }).addTo(locationSelectMap);

  selectedLocation = center;

  locationSelectMap.on('click', (e) => {
    selectedLocationMarker.setLatLng(e.latlng);
    selectedLocation = [e.latlng.lat, e.latlng.lng];
  });

  selectedLocationMarker.on('dragend', (e) => {
    const marker = e.target;
    const position = marker.getLatLng();
    selectedLocation = [position.lat, position.lng];
  });

  setTimeout(() => {
    try { locationSelectMap.invalidateSize(); } catch (e) { /* ignore */ }
  }, 120);
}

/* -------------------- SETTINGS STATE -------------------- */
const settings = {
  darkMode: true,
  showLocation: true,
  notifications: true,
  searchRadius: 2.5,
  autoRefresh: false,
  vibration: true,
  pulseVisibility: false,
  visibilityMode: 'public',
  language: 'ru'
};

/* -------------------- THEME MANAGEMENT -------------------- */
function applyTheme(isDark) {
  const root = document.documentElement;
  if (isDark) {
    root.setAttribute('data-theme', 'dark');
    // Switch to dark tiles properly
    try {
      if (map.hasLayer(lightTileLayer)) map.removeLayer(lightTileLayer);
    } catch (e) {}
    if (!map.hasLayer(darkTileLayer)) darkTileLayer.addTo(map);
    // update locationSelectMap tiles if present
    if (locationSelectMap) {
      locationSelectMap.eachLayer((layer) => {
        if (layer instanceof L.TileLayer) locationSelectMap.removeLayer(layer);
      });
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(locationSelectMap);
      setTimeout(() => { try { locationSelectMap.invalidateSize(); } catch(e){} }, 100);
    }
  } else {
    root.setAttribute('data-theme', 'light');
    // Switch to light tiles properly
    try {
      if (map.hasLayer(darkTileLayer)) map.removeLayer(darkTileLayer);
    } catch (e) {}
    if (!map.hasLayer(lightTileLayer)) lightTileLayer.addTo(map);
    if (locationSelectMap) {
      locationSelectMap.eachLayer((layer) => {
        if (layer instanceof L.TileLayer) locationSelectMap.removeLayer(layer);
      });
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(locationSelectMap);
      setTimeout(() => { try { locationSelectMap.invalidateSize(); } catch(e){} }, 100);
    }
  }

  // After changing tile layers, invalidate size so tiles render correctly in WebViews
  setTimeout(() => {
    try { map.invalidateSize(); } catch (e) { console.warn('invalidateSize failed', e); }
    // also force a small pan to trigger tile redraw on some engines
    try { map.panBy([0.0001, 0.0001], {animate:false}); } catch(e){}
  }, 120);

  // Ensure mask/ring radiuses match settings if changed
  mask.setRadius(radiusMeters);
  ring.setRadius(radiusMeters);
}

/* -------------------- UI: chips -------------------- */
const categories = [
  { id: 'all', label: '–í—Å–µ' },
  { id: 'sport', label: '–°–ø–æ—Ä—Ç' },
  { id: 'games', label: '–ò–≥—Ä—ã' },
  { id: 'art', label: '–ò—Å–∫—É—Å—Å—Ç–≤–æ' },
  { id: 'social', label: '–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ' },
  { id: 'creative', label: '–ö—Ä–µ–∞—Ç–∏–≤' },
  { id: 'chill', label: '–û—Ç–¥—ã—Ö' },
  { id: 'active', label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
  { id: 'dating', label: '–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞' },
  { id: 'education', label: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ' },
  { id: 'animal', label: '–ñ–∏–≤–æ—Ç–Ω—ã–µ' },
  { id: 'help', label: '–ü–æ–º–æ—â—å' }
];

const chips = document.getElementById('chips');
categories.forEach((c, i) => {
  const el = document.createElement('button');
  el.className = 'chip' + (i === 0 ? ' active' : '');
  el.dataset.cat = c.id;
  el.textContent = c.label;
  el.onclick = () => {
    document.querySelectorAll('.chip').forEach(ch => ch.classList.remove('active'));
    el.classList.add('active');
    renderPulses();
  };
  chips.appendChild(el);
});

function activeCat() {
  const el = document.querySelector('.chip.active');
  return el ? el.dataset.cat : 'all';
}

/* -------------------- DATA MODEL -------------------- */
const state = {
  pulses: new Map(),
  me: { lat: center[0], lng: center[1] },
  customLocation: null,
  selectedLocation: null,
  myPulses: new Set(), // Track user's own pulses
  selectedPulseId: null // Track currently selected pulse for deletion
};

function getEmojiForCategory(cat) {
  const emojis = {
    'sport': 'üèÉ',
    'games': 'üéÆ',
    'art': 'üé®',
    'social': 'üë•',
    'creative': 'üí°',
    'chill': 'üòå',
    'active': '‚ö°',
    'dating': 'üíï',
    'education': 'üìö',
    'animal': 'üêï',
    'help': 'ü§ù'
  };
  return emojis[cat] || 'üìç';
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
function getPulseStyle(createdAt) {
  const now = new Date();
  const created = new Date(createdAt);
  const diffMs = now - created;
  const diffMins = Math.floor(diffMs / 60000);
  
  if (diffMins < 30) {
    return { colorClass: 'pulse-green', animationClass: 'ring-fast' };
  } else if (diffMins < 60) {
    return { colorClass: 'pulse-orange', animationClass: 'ring-medium' };
  } else {
    return { colorClass: 'pulse-red', animationClass: 'ring-slow' };
  }
}

/* Distance util (meters) */
function distanceMeters(lat1, lng1, lat2, lng2) {
  const R = 6378137;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function withinRadius(lat, lng) {
  return distanceMeters(center[0], center[1], lat, lng) <= radiusMeters;
}

/* -------------------- RENDER -------------------- */
function formatTimeAgo(createdAt) {
  const now = new Date();
  const created = new Date(createdAt);
  const diffMs = now - created;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);

  const t = translations[currentLanguage];
  
  if (diffMins < 1) return t.justNow;
  if (diffMins < 60) return `${diffMins}${t.minutesAgo}`;
  if (diffHours < 24) return `${diffHours}${t.hoursAgo}`;
  return `${Math.floor(diffHours / 24)}${t.daysAgo}`;
}

function makeMarker(row) {
  const emoji = getEmojiForCategory(row.category);
  const pulseStyle = getPulseStyle(row.created_at);
  
  const iconHtml = `<div class="pulse ${pulseStyle.colorClass}">
      <div class="ring ${pulseStyle.animationClass}"></div><span>${emoji}</span>
    </div>`;
    
  const icon = L.divIcon({ className: '', html: iconHtml, iconSize: [52, 52], iconAnchor: [26, 26] });
  const m = L.marker([row.lat, row.lng], { icon }).addTo(pulsesLayer);

  const timeAgo = formatTimeAgo(row.created_at);
  const t = translations[currentLanguage];
  const isMyPulse = state.myPulses.has(row.id);
  
  let buttonsHtml = '';
  if (isMyPulse) {
    buttonsHtml = `<button class="delete-btn" onclick="deletePulse('${row.id}')">${t.delete}</button>`;
  } else {
    buttonsHtml = `<button class="join-btn" onclick="joinPulse('${row.id}')">${t.join}</button>`;
  }

  m.bindTooltip(
    `<div style="text-align:center">
      <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(row.message || '')}</div>
      ${isMyPulse ? '<div style="color: var(--grad2); font-size: 10px; margin-bottom: 4px;">' + t.yourPulse + '</div>' : ''}
      <div class="pulse-time">${timeAgo}</div>
      ${buttonsHtml}
    </div>`,
    { className: 'pulse-label', direction: 'bottom', offset: [0, 28], opacity: 1, permanent: false }
  );
  
  m.on('click', () => {
    m.openTooltip();
    // Show delete button if this is user's pulse
    if (isMyPulse) {
      state.selectedPulseId = row.id;
      document.getElementById('deletePulseBtn').style.display = 'grid';
    } else {
      document.getElementById('deletePulseBtn').style.display = 'none';
    }
  });
  
  return m;
}

// –£–ü–†–û–©–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—É–ª—å—Å–∞
async function deletePulse(pulseId) {
  const t = translations[currentLanguage];
  if (confirm(t.deleteConfirm)) {
    const { error } = await db
      .from('pulses')
      .update({ status: 'deleted' })
      .eq('id', pulseId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
      return;
    }

    state.pulses.delete(pulseId);
    state.myPulses.delete(pulseId);
    if (state.selectedPulseId === pulseId) {
      state.selectedPulseId = null;
      document.getElementById('deletePulseBtn').style.display = 'none';
    }
    renderPulses();
    
    if (settings.vibration && navigator.vibrate) {
      navigator.vibrate(50);
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—É–ª—å—Å–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
async function deleteSelectedPulse() {
  if (!state.selectedPulseId) return;
  await deletePulse(state.selectedPulseId);
}

function joinPulse(pulseId) {
  const pulse = state.pulses.get(pulseId);
  if (pulse) {
    const pulseData = pulse.row;
    const t = translations[currentLanguage];
    alert(`üéâ ${t.join}!\n\n"${pulseData.message}"\n\n–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –æ—Ç–∫—Ä—ã–ª–æ –±—ã —á–∞—Ç —Å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º!`);

    if (pulse.marker) {
      pulse.marker.closeTooltip();
    }
  }
}

function renderPulses() {
  pulsesLayer.clearLayers();
  const cat = activeCat();
  const now = Date.now();
  for (const [id, entry] of state.pulses) {
    const r = entry.row;
    if (r.status !== 'active') continue;
    if (r.expires_at && new Date(r.expires_at).getTime() < now) continue;
    if (cat !== 'all' && r.category !== cat) continue;
    if (!withinRadius(r.lat, r.lng)) continue;
    entry.marker = makeMarker(r);
  }
}

/* -------------------- GEO - –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –õ–û–ö–ê–¶–ò–ò -------------------- */
let watchId = null;
let lastReportedPos = null;
let permissionState = 'unknown';

/* Move center circle and marker only if locationFixed is false and moved more than threshold */
function moveCircle(lat, lng) {
  if (locationFixed) return;

  // Only update if moved a reasonable distance to avoid jitter
  if (lastReportedPos) {
    const dist = distanceMeters(lastReportedPos.lat, lastReportedPos.lng, lat, lng);
    if (dist < 25) return; // ignore tiny movements under 25 meters
  }

  center = [lat, lng];
  mask.setLatLng(center); 
  ring.setLatLng(center);
  meMarker.setLatLng(center);
  state.me = { lat: lat, lng: lng };
  lastReportedPos = { lat, lng };
  renderPulses();
}

function fixLocation(lat, lng) {
  locationFixed = true;
  center = [lat, lng];
  mask.setLatLng(center);
  ring.setLatLng(center);
  meMarker.setLatLng(center);
  state.me = { lat: lat, lng: lng };
  map.setView([lat, lng], 14);
  renderPulses();
}

// Improved location tracking:
// - Use Permissions API to avoid re-requesting permission repeatedly
// - Keep a single watchPosition (don't call getCurrentPosition repeatedly)
// - Pause requesting when user denies
async function startLocationTracking() {
  if (!('geolocation' in navigator)) {
    console.log('Geolocation not available');
    return;
  }

  // If watch already active, do not re-create it (prevents repeated prompts)
  if (watchId) {
    return;
  }

  // Query permission state if available
  try {
    if (navigator.permissions && navigator.permissions.query) {
      const perm = await navigator.permissions.query({ name: 'geolocation' });
      permissionState = perm.state;
      perm.onchange = () => {
        permissionState = perm.state;
      };
    }
  } catch (e) {
    console.log('Permissions API unavailable', e);
  }

  // If permission is 'denied', don't attempt to ask again automatically
  if (permissionState === 'denied') {
    console.log('Geolocation permission denied; not requesting.');
    return;
  }

  // Request initial position once only if we don't have lastReportedPos
  // We avoid calling getCurrentPosition repeatedly (it may re-trigger prompts on some platforms)
  if (!lastReportedPos) {
    try {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        // Do not call fixLocation here if we want continuous updates and avoid repeated center resets.
        // Use moveCircle to set initial and keep tracking.
        moveCircle(latitude, longitude);
      }, err => {
        console.log('Initial getCurrentPosition failed', err);
      }, { enableHighAccuracy: true, timeout: 15000 });
    } catch (e) {
      console.log('getCurrentPosition failed', e);
    }
  }

  // Start watchPosition once (this will not prompt on many platforms if permission already granted)
  try {
    watchId = navigator.geolocation.watchPosition(
      pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        // Only use updates with acceptable accuracy
        if (typeof accuracy === 'number' && accuracy > 150) {
          // too inaccurate, skip
          return;
        }
        // Update only if moved sufficiently (this prevents small background jiggling)
        if (!lastReportedPos) {
          moveCircle(latitude, longitude);
        } else {
          const moved = distanceMeters(lastReportedPos.lat, lastReportedPos.lng, latitude, longitude);
          // update when user moved > ~30-50 meters or when accuracy improves
          if (moved > 30 || (accuracy && accuracy < 50)) {
            moveCircle(latitude, longitude);
          }
        }
      },
      error => {
        console.log('Location tracking error:', error);
        // if permission denied, mark state and clear watch to avoid repeated prompts
        if (error && error.code === 1) {
          permissionState = 'denied';
          if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
        }
      },
      {
        enableHighAccuracy: true,
        maximumAge: 5000, // accept cached positions up to 5s
        timeout: 27000
      }
    );
  } catch (e) {
    console.log('watchPosition creation failed', e);
  }
}

// Stop tracking (used when user toggles showLocation off)
function stopLocationTracking() {
  if (watchId) {
    try {
      navigator.geolocation.clearWatch(watchId);
    } catch (e) { /* ignore */ }
    watchId = null;
  }
}

/* Start tracking on load if setting allows */
startLocationTracking();

/* Also respect visibility change: do NOT re-request permission on visibility change.
   But when returning to visible, keep existing watch active. */
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // optional: reduce frequency by stopping watch if you want to reduce battery,
    // but per user's request we keep real-time updates; we won't call getCurrentPosition again.
    // stopLocationTracking();
  } else {
    // When becoming visible, ensure tracking is running if user wants location and permission wasn't denied
    if (settings.showLocation && !watchId && permissionState !== 'denied') {
      startLocationTracking();
    }
    // Invalidate map size to force tiles to render if something was clipped while hidden
    setTimeout(() => {
      try { map.invalidateSize(); } catch (e) {}
    }, 120);
  }
});

/* -------------------- SUPABASE I/O -------------------- */
async function loadInitial() {
  const { data, error } = await db
    .from('pulses')
    .select('id, created_at, author_tg_id, category, message, lat, lng, expires_at, status, people_count')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .order('created_at', { ascending: false })
    .limit(300);

  if (error) { console.error(error); return; }
  
  // Get current user ID for identifying own pulses
  let currentUserId = null;
  try {
    const tg = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe;
    if (tg && tg.user) currentUserId = String(tg.user.id);
  } catch (_) { }

  data.forEach(row => {
    state.pulses.set(row.id, { row, marker: null });
    // Mark user's own pulses
    if (currentUserId && row.author_tg_id === currentUserId) {
      state.myPulses.add(row.id);
    }
  });
  renderPulses();

  // ensure tiles are requested/rendered after loading initial data
  setTimeout(() => { try { map.invalidateSize(); } catch(e){} }, 120);
}

function subscribeRealtime() {
  db.channel('realtime:pulses')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pulses' }, payload => {
      const row = payload.new;
      state.pulses.set(row.id, { row, marker: null });
      
      // Check if this is user's own pulse
      let currentUserId = null;
      try {
        const tg = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe;
        if (tg && tg.user) currentUserId = String(tg.user.id);
      } catch (_) { }
      
      if (currentUserId && row.author_tg_id === currentUserId) {
        state.myPulses.add(row.id);
      }
      
      renderPulses();
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'pulses' }, payload => {
      const row = payload.new;
      state.pulses.set(row.id, { row, marker: null });
      renderPulses();
    })
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'pulses' }, payload => {
      const row = payload.old;
      state.pulses.delete(row.id);
      state.myPulses.delete(row.id);
      if (state.selectedPulseId === row.id) {
        state.selectedPulseId = null;
        document.getElementById('deletePulseBtn').style.display = 'none';
      }
      renderPulses();
    })
    .subscribe();
}

/* -------------------- CREATE PULSE UI -------------------- */
const createBtn = document.getElementById('createBtn');
const createModal = document.getElementById('createModal');
const addressLocationBtn = document.getElementById('addressLocation');
const customLocationBtn = document.getElementById('customLocation');
const addressInputContainer = document.getElementById('addressInputContainer');
const locationMapContainer = document.getElementById('locationMapContainer');
const catSelect = document.getElementById('cat');
const msgTextarea = document.getElementById('msg');
const locationOverlay = document.getElementById('locationOverlay');

// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞
catSelect.addEventListener('change', function () {
  const category = this.value;
  const hints = categoryHints[currentLanguage];
  msgTextarea.placeholder = hints[category] || translations[currentLanguage].writeMessage;
});

document.getElementById('cancelCreate').onclick = () => {
  createModal.classList.remove('open');
  locationMapContainer.style.display = 'none';
  addressInputContainer.style.display = 'block';
};

createBtn.onclick = () => {
  createModal.classList.add('open');
  const category = catSelect.value;
  const hints = categoryHints[currentLanguage];
  msgTextarea.placeholder = hints[category] || translations[currentLanguage].writeMessage;
};

addressLocationBtn.onclick = () => {
  addressLocationBtn.classList.add('active');
  customLocationBtn.classList.remove('active');
  locationMapContainer.style.display = 'none';
  addressInputContainer.style.display = 'block';
  state.selectedLocation = null;
};

customLocationBtn.onclick = () => {
  customLocationBtn.classList.add('active');
  addressLocationBtn.classList.remove('active');
  locationMapContainer.style.display = 'block';
  addressInputContainer.style.display = 'none';

  locationOverlay.classList.add('active');

  if (!locationSelectMap) {
    initLocationSelectionMap();
  } else {
    locationSelectMap.setView(center, 15);
    selectedLocationMarker.setLatLng(center);
    selectedLocation = center;
    try { locationSelectMap.invalidateSize(); } catch(e){}
  }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–≤–µ—Ä–ª–µ—è –≤—ã–±–æ—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏
document.getElementById('cancelLocationSelect').onclick = () => {
  locationOverlay.classList.remove('active');
};

document.getElementById('confirmLocationSelect').onclick = () => {
  if (selectedLocation) {
    state.selectedLocation = selectedLocation;
    locationOverlay.classList.remove('active');
    document.getElementById('addressInput').value = `–õ–æ–∫–∞—Ü–∏—è: ${selectedLocation[0].toFixed(6)}, ${selectedLocation[1].toFixed(6)}`;
  }
};

document.getElementById('saveCreate').onclick = async () => {
  const cat = document.getElementById('cat').value;
  const msg = document.getElementById('msg').value.trim().slice(0, 180);
  const peopleCount = Number(document.getElementById('peopleCount').value) || 5;
  const addressInput = document.getElementById('addressInput').value.trim();

  let pulseLat, pulseLng;

  if (state.selectedLocation) {
    [pulseLat, pulseLng] = state.selectedLocation;
  } else if (addressInput && addressInput !== "–≤–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å" && !addressInput.startsWith("–õ–æ–∫–∞—Ü–∏—è:")) {
    pulseLat = state.me.lat ?? center[0];
    pulseLng = state.me.lng ?? center[1];
  } else {
    pulseLat = state.me.lat ?? center[0];
    pulseLng = state.me.lng ?? center[1];
  }

  const expires = new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString();

  let tgId = null;
  try {
    const tg = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe;
    if (tg && tg.user) tgId = String(tg.user.id);
  } catch (_) { }

  const row = {
    category: cat,
    message: msg || 'ping',
    lat: pulseLat,
    lng: pulseLng,
    expires_at: expires,
    status: 'active',
    author_tg_id: tgId,
    people_count: peopleCount
  };

  const { data, error } = await db.from('pulses').insert(row).select().single();
  if (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª—å—Å–∞: ' + (error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
    return;
  }

  state.pulses.set(data.id, { row: data, marker: null });
  
  // Mark as user's own pulse
  if (tgId) {
    state.myPulses.add(data.id);
  }
  
  renderPulses();
  createModal.classList.remove('open');
  locationMapContainer.style.display = 'none';
  addressInputContainer.style.display = 'block';
  document.getElementById('msg').value = '';
  document.getElementById('addressInput').value = '';
};

/* -------------------- SETTINGS FUNCTIONALITY -------------------- */
const settingsModal = document.getElementById('settingsModal');
const settingsBtn = document.getElementById('settingsBtn');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
function initSettings() {
  const savedSettings = localStorage.getItem('radius5_settings');
  if (savedSettings) {
    Object.assign(settings, JSON.parse(savedSettings));
  }

  const savedLanguage = localStorage.getItem('radius5_language');
  if (savedLanguage) {
    currentLanguage = savedLanguage;
  }

  applySettings();
  updateSettingsUI();
  applyLanguage(currentLanguage);
}

function applySettings() {
  applyTheme(settings.darkMode);

  radiusMeters = settings.searchRadius * 1000;
  mask.setRadius(radiusMeters);
  ring.setRadius(radiusMeters);

  if (settings.showLocation) {
    meMarker.addTo(map);
    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
    startLocationTracking();
  } else {
    meMarker.remove();
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ
    stopLocationTracking();
  }

  renderPulses();
}

function updateSettingsUI() {
  document.getElementById('darkModeToggle').classList.toggle('active', settings.darkMode);
  document.getElementById('showLocationToggle').classList.toggle('active', settings.showLocation);
  document.getElementById('notificationsToggle').classList.toggle('active', settings.notifications);
  document.getElementById('autoRefreshToggle').classList.toggle('active', settings.autoRefresh);
  document.getElementById('vibrationToggle').classList.toggle('active', settings.vibration);
  document.getElementById('pulseVisibilityToggle').classList.toggle('active', settings.pulseVisibility);
  
  document.getElementById('radiusSlider').value = settings.searchRadius;
  document.getElementById('radiusValue').textContent = settings.searchRadius + ' –∫–º';
  
  // Update visibility options
  document.getElementById('visibilityOptions').classList.toggle('active', settings.pulseVisibility);
  document.querySelectorAll('[data-visibility]').forEach(toggle => {
    toggle.classList.toggle('active', toggle.dataset.visibility === settings.visibilityMode);
  });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–æ–≥–≥–ª–æ–≤
document.querySelectorAll('.toggle').forEach(toggle => {
  toggle.addEventListener('click', function () {
    this.classList.toggle('active');
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ —Ä–∞–¥–∏—É—Å–∞
document.getElementById('radiusSlider').addEventListener('input', function () {
  settings.searchRadius = parseFloat(this.value);
  document.getElementById('radiusValue').textContent = settings.searchRadius + ' –∫–º';
});

// Pulse visibility toggle
document.getElementById('pulseVisibilityToggle').addEventListener('click', function() {
  settings.pulseVisibility = this.classList.contains('active');
  document.getElementById('visibilityOptions').classList.toggle('active', settings.pulseVisibility);
});

// Visibility mode toggles
document.querySelectorAll('[data-visibility]').forEach(toggle => {
  toggle.addEventListener('click', function() {
    document.querySelectorAll('[data-visibility]').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    settings.visibilityMode = this.dataset.visibility;
  });
});

// Language selection
document.querySelectorAll('.language-option').forEach(option => {
  option.addEventListener('click', function() {
    const lang = this.dataset.lang;
    applyLanguage(lang);
    settings.language = lang;
  });
});

// –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
settingsBtn.onclick = () => {
  settingsModal.classList.add('open');
  updateSettingsUI();
};

document.getElementById('cancelSettings').onclick = () => {
  settingsModal.classList.remove('open');
  initSettings();
};

document.getElementById('saveSettings').onclick = () => {
  settings.darkMode = document.getElementById('darkModeToggle').classList.contains('active');
  settings.showLocation = document.getElementById('showLocationToggle').classList.contains('active');
  settings.notifications = document.getElementById('notificationsToggle').classList.contains('active');
  settings.autoRefresh = document.getElementById('autoRefreshToggle').classList.contains('active');
  settings.vibration = document.getElementById('vibrationToggle').classList.contains('active');
  settings.pulseVisibility = document.getElementById('pulseVisibilityToggle').classList.contains('active');

  localStorage.setItem('radius5_settings', JSON.stringify(settings));
  localStorage.setItem('radius5_language', currentLanguage);

  applySettings();

  settingsModal.classList.remove('open');

  if (settings.vibration && navigator.vibrate) {
    navigator.vibrate(50);
  }
  
  const t = translations[currentLanguage];
  alert(t.save + '!');
};

/* -------------------- HELPERS -------------------- */
function escapeHtml(s) {
  return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
}

/* -------------------- INIT -------------------- */
loadInitial();
subscribeRealtime();
initSettings();

// Add click handler for delete button
document.getElementById('deletePulseBtn').addEventListener('click', deleteSelectedPulse);

// Hide delete button when clicking on map (not on markers)
map.on('click', e => {
  // Check if click was on a marker (if so, don't hide delete button)
  const point = map.latLngToContainerPoint(e.latlng);
  const isMarkerClick = Object.values(pulsesLayer._layers).some(layer => {
    if (layer instanceof L.Marker) {
      const markerPoint = map.latLngToContainerPoint(layer.getLatLng());
      const distance = Math.sqrt(
        Math.pow(point.x - markerPoint.x, 2) + 
        Math.pow(point.y - markerPoint.y, 2)
      );
      return distance < 30; // If click within 30px of marker center
    }
    return false;
  });
  
  if (!isMarkerClick) {
    document.getElementById('deletePulseBtn').style.display = 'none';
    state.selectedPulseId = null;
  }
});

setInterval(() => {
  if (settings.autoRefresh) {
    renderPulses();
  }
}, 60000);
</script>
</body>
</html>