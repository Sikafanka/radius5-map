<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Radius 5 — Almaty</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>

  <!-- Turf.js for geodesic circle -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html,body,#map{margin:0;height:100%;width:100%;background:#000;overflow:hidden}
    .ui {
      position: absolute; left: 0; right: 0; top: 0;
      display: flex; justify-content: center; pointer-events: none;
    }
    .banner {
      margin: 12px; padding: 10px 14px; border-radius: 10px;
      background: rgba(17,17,24,.85); color: #e5e7eb; font: 600 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow: 0 8px 30px rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.08);
      pointer-events: auto; backdrop-filter: blur(6px);
    }
    .btn {
      margin-left: 10px; padding: 9px 14px; border-radius: 9999px; font-weight: 700; cursor: pointer;
      background: linear-gradient(90deg,#a855f7,#3b82f6); color: #fff; border: 0;
    }
    /* спрятать любые контролы Mapbox, если вдруг появятся */
    .mapboxgl-ctrl-top-right,.mapboxgl-ctrl-bottom-right,.mapboxgl-ctrl-bottom-left { display:none !important; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div id="banner" class="banner" style="display:none">
      Location is off. Radius shown from city center.
      <button id="locBtn" class="btn">Use my location</button>
    </div>
  </div>

  <script>
    // ===== Mapbox creds (твои) =====
    const ACCESS_TOKEN = 'pk.eyJ1Ijoic2lrYWZhbmthOTEiLCJhIjoiY21nczNuYmxrMG1yeTJsczhna2dsZHJ6ZCJ9.Svpm2ZWpAJFdaS54BiInUQ';
    const STYLE_URL   = 'https://api.mapbox.com/styles/v1/sikafanka91/cmgs3sw6a001l01r70vif0yx9?access_token=' + ACCESS_TOKEN;

    // Алматы по умолчанию
    const ALMATY_CENTER = [76.8897, 43.2389];

    mapboxgl.accessToken = ACCESS_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_URL,
      center: ALMATY_CENTER,
      zoom: 12,
      attributionControl: false
    });

    // источники/слои после load
    map.on('load', () => {
      initCircle(ALMATY_CENTER);      // рисуем 5 км от центра
      tryGetLocation(false);          // пробуем тихо достать геолокацию
    });

    // рисуем круг и точку
    function initCircle(centerLngLat) {
      const circle = turf.circle(centerLngLat, 5, { units: 'kilometers', steps: 128 });

      if (!map.getSource('r5')) {
        map.addSource('r5', { type: 'geojson', data: circle });
        map.addLayer({
          id: 'r5-glow',
          type: 'line',
          source: 'r5',
          paint: { 'line-color':'#7C3AED','line-width':18,'line-blur':16,'line-opacity':0.35 }
        });
        map.addLayer({
          id: 'r5-fill',
          type: 'fill',
          source: 'r5',
          paint: { 'fill-color':'#7C3AED', 'fill-opacity':0.16 }
        });
        map.addLayer({
          id: 'r5-stroke',
          type: 'line',
          source: 'r5',
          paint: { 'line-color':'#60A5FA','line-width':3,'line-blur':1.1,'line-opacity':0.95 }
        });

        map.addSource('r5-center',{ type:'geojson', data:{ type:'Feature', geometry:{ type:'Point', coordinates:centerLngLat } }});
        map.addLayer({
          id:'r5-center-dot', type:'circle', source:'r5-center',
          paint:{ 'circle-radius':5,'circle-color':'#38BDF8','circle-stroke-width':2,'circle-stroke-color':'#0B0F16' }
        });
      } else {
        map.getSource('r5').setData(circle);
        map.getSource('r5-center').setData({ type:'Feature', geometry:{ type:'Point', coordinates:centerLngLat }});
      }

      const bbox = turf.bbox(circle);
      map.fitBounds(bbox, { padding: 40, duration: 600 });
      pulse(); // неоновая анимация
    }

    // простая анимация пульса
    let started = false;
    function pulse(){
      if (started) return; started = true;
      let t0 = performance.now();
      (function anim(){
        const t = (performance.now()-t0)/1000, p = (Math.sin(t*2.2)+1)/2;
        map.setPaintProperty('r5-fill','fill-opacity',0.12+p*0.10);
        map.setPaintProperty('r5-glow','line-width',14+p*8);
        map.setPaintProperty('r5-glow','line-opacity',0.25+p*0.20);
        requestAnimationFrame(anim);
      })();
    }

    // === Геолокация ===
    const banner = document.getElementById('banner');
    const locBtn = document.getElementById('locBtn');

    function tryGetLocation(requireGesture) {
      if (!('geolocation' in navigator)) {
        banner.style.display = 'block';
        return;
      }
      // некоторые WebView дают геолокацию только после клика
      if (requireGesture) {
        navigator.geolocation.getCurrentPosition(
          onPos, onGeoError, { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
        );
      } else {
        // тихая попытка
        navigator.geolocation.getCurrentPosition(
          onPos,
          () => { banner.style.display = 'block'; }, // покажем кнопку
          { enableHighAccuracy:false, timeout:3000, maximumAge:10000 }
        );
      }
    }

    function onPos(pos) {
      banner.style.display = 'none';
      const lng = pos.coords.longitude;
      const lat = pos.coords.latitude;
      initCircle([lng, lat]);
      // синяя точка юзера
      if (!map.getSource('me')) {
        map.addSource('me', { type:'geojson', data:{ type:'Feature', geometry:{ type:'Point', coordinates:[lng,lat] } } });
        map.addLayer({ id:'me-dot', type:'circle', source:'me',
          paint:{ 'circle-radius':6,'circle-color':'#22d3ee','circle-stroke-width':2,'circle-stroke-color':'#111827' } });
      } else {
        map.getSource('me').setData({ type:'Feature', geometry:{ type:'Point', coordinates:[lng,lat] } });
      }
    }
    function onGeoError(){ banner.style.display = 'block'; }
    locBtn.addEventListener('click', () => tryGetLocation(true));
  </script>
</body>
</html>
